<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleurarose Admin</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:#f6f7fb}
    .wrap{max-width:980px;margin:16px auto;padding:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:14px}
    h1{margin:0 0 8px;font-size:20px}
    .sub{margin:0 0 10px;color:#6b7280;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;font-size:13px;vertical-align:top}
    th{color:#6b7280;text-align:left;font-weight:700}
    .btn{border:0;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
    .ok{background:#111827;color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f1f5f9;font-size:12px}
    .msg{margin-top:10px;padding:10px;border-radius:12px;display:none;white-space:pre-line}
    .good{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .bad{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fleurarose Admin</h1>
      <p class="sub" id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</p>

      <div class="row" style="margin:10px 0">
        <button class="btn ghost" id="btnRefresh">‚ü≥ ‡πÇ‡∏´‡∏•‡∏î Pending</button>
      </div>

      <div class="msg good" id="msgOk"></div>
      <div class="msg bad" id="msgErr"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Booking</th>
              <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏á‡∏≤‡∏ô</th>
              <th>‡∏ß‡∏±‡∏ô/‡∏£‡∏≠‡∏ö</th>
              <th>‡∏ó‡∏µ‡∏°</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="sub" style="margin-top:10px">
        üí¨ Ping = ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡πÅ‡∏ä‡∏ó‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏ô OA<br/>
        ‚úÖ Confirm = ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Confirmed + ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar + ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡πÇ‡∏ï‡πâ
      </p>
    </div>
  </div>

<script>
const LIFF_ID = "2008882886-ubJheqfN";          // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ
const GAS_URL = "PUT_YOUR_GAS_EXEC_URL_HERE";   // ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

let adminProfile = { userId:"", displayName:"" };
const $ = (id)=>document.getElementById(id);
const okBox = $("msgOk");
const errBox = $("msgErr");
function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; }

async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    adminProfile = await liff.getProfile();
    $("hello").textContent = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô " + (adminProfile.displayName || "");
    await loadPending();
  }catch(e){
    $("hello").textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE (LIFF) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
  }
}

async function loadPending(){
  clearMsg();
  $("tbody").innerHTML = "<tr><td colspan='6'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>";
  try{
    const url = GAS_URL + "?action=listPending";
    const res = await fetch(url, { method:"GET" });
    const txt = await res.text();
    const data = JSON.parse(txt);

    if (!data.ok) throw new Error(data.error || "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    const rows = data.rows || [];
    if (!rows.length){
      $("tbody").innerHTML = "<tr><td colspan='6'>‡πÑ‡∏°‡πà‡∏°‡∏µ Pending üéâ</td></tr>";
      return;
    }

    $("tbody").innerHTML = rows.map(r => `
      <tr>
        <td>
          <div><b>${escapeHtml(r.booking_id)}</b></div>
          <div class="pill">${escapeHtml(r.line_display_name || "-")}</div>
        </td>
        <td>
          <div>${escapeHtml(r.customer_name)}</div>
          <div>${escapeHtml(r.phone)}</div>
        </td>
        <td>
          <div><b>${escapeHtml(r.job_type)}</b></div>
          <div>${escapeHtml(r.location || "-")}</div>
          <div style="color:#6b7280">${escapeHtml(r.notes || "")}</div>
        </td>
        <td>
          <div>${escapeHtml(r.event_date)}</div>
          <div class="pill">${escapeHtml(r.time_slot)}</div>
        </td>
        <td><b>${escapeHtml(r.team_assigned || "-")}</b></td>
        <td>
          <div class="row">
            <button class="btn ghost" onclick="ping('${escapeAttr(r.booking_id)}')">üí¨ Ping</button>
            <button class="btn ok" onclick="confirmBooking('${escapeAttr(r.booking_id)}')">‚úÖ Confirm</button>
          </div>
        </td>
      </tr>
    `).join("");

  }catch(err){
    showErr("‡πÇ‡∏´‡∏•‡∏î Pending ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
    $("tbody").innerHTML = "<tr><td colspan='6'>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>";
  }
}

async function ping(bookingId){
  clearMsg();
  try{
    const res = await fetch(GAS_URL, {
      method:"POST",
      body: JSON.stringify({
        action:"ping",
        booking_id: bookingId,
        admin_line_user_id: adminProfile.userId
      })
    });
    const data = JSON.parse(await res.text());
    if (!data.ok) throw new Error(data.error || "Ping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    showOk("Ping ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
  }catch(err){
    showErr("Ping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
  }
}

async function confirmBooking(bookingId){
  clearMsg();
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")) return;

  try{
    const res = await fetch(GAS_URL, {
      method:"POST",
      body: JSON.stringify({
        action:"confirm",
        booking_id: bookingId,
        admin_line_user_id: adminProfile.userId
      })
    });

    const data = JSON.parse(await res.text());
    if (!data.ok) {
      if (data.error === "slot_full") throw new Error("‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß (capacity ‡πÄ‡∏ï‡πá‡∏°)");
      throw new Error(data.error || "Confirm ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    showOk("Confirm + Calendar + ‡∏Ç‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
    await loadPending();
  }catch(err){
    showErr("Confirm ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
  }
}

$("btnRefresh").addEventListener("click", loadPending);

function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return String(s||"").replace(/'/g,"&#39;"); }

init();
</script>
</body>
</html>
