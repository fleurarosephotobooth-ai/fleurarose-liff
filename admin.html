<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;font-family:system-ui;background:#f6f7fb}
    .wrap{padding:16px}
    h1{margin:0 0 10px}
    .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #eee;vertical-align:top}
    th{color:#666;text-align:left;font-weight:700;font-size:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
    .pending{background:#fff7ed;color:#9a3412}
    .confirmed{background:#ecfdf5;color:#166534}
    .btn{border:0;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700}
    .btnChat{background:#f1f3f7}
    .btnConfirm{background:#111;color:#fff}
    .rowPending{background:#fffaf1}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Fleurarose Admin</h1>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏á‡∏≤‡∏ô</th>
          <th>‡∏ß‡∏±‡∏ô/‡∏£‡∏≠‡∏ö</th>
          <th>‡∏ó‡∏µ‡∏°</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<script>
function pill(status){
  if(status==="Pending") return '<span class="pill pending">Pending</span>';
  if(status==="Confirmed") return '<span class="pill confirmed">Confirmed</span>';
  return status || "";
}

function render(rows){
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  rows.reverse().forEach(r=>{
    const tr = document.createElement("tr");
    if(r.status==="Pending") tr.className="rowPending";

    tr.innerHTML = `
      <td>${r.created_at ? new Date(r.created_at).toLocaleString("th-TH") : ""}</td>
      <td><b>${r.customer_name||""}</b><br>${r.line_display_name||""}<br>${r.phone||""}</td>
      <td>${r.job_type||""}<br><small>${r.location||""}</small></td>
      <td>${r.event_date||""}<br>${r.time_slot||""}</td>
      <td>${r.team_assigned||""}</td>
      <td>${pill(r.status)}</td>
      <td>
        <button class="btn btnChat" onclick="ping('${r.line_user_id||""}')">üí¨</button>
        <button class="btn btnConfirm" onclick="confirmB('${r.booking_id||""}')">Confirm</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function load(){
  google.script.run
    .withSuccessHandler(render)
    .withFailureHandler(e=>alert(e.message||e))
    .getBookings();
}

function ping(uid){
  google.script.run
    .withSuccessHandler(()=>alert("‡∏™‡πà‡∏á ping ‡πÅ‡∏•‡πâ‡∏ß"))
    .withFailureHandler(e=>alert(e.message||e))
    .pingCustomer(uid);
}

function confirmB(id){
  if(!confirm("Confirm ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
  google.script.run
    .withSuccessHandler(()=>{ alert("Confirmed + ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar + ‡∏™‡πà‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß"); load(); })
    .withFailureHandler(e=>alert(e.message||e))
    .confirmBooking(id);
}

load();
</script>
</body>
</html>
