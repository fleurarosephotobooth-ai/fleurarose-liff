<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleurarose Admin Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--primary:#0f172a;--primary2:#111827}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:780px;margin:16px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.07);padding:18px}
    h1{margin:0 0 6px;font-size:22px}
    .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.4}
    label{display:block;margin-top:12px;color:var(--muted);font-size:13px}
    input,select,textarea{width:100%;box-sizing:border-box;margin-top:6px;padding:12px;border:1px solid var(--line);border-radius:14px;font-size:15px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:16px;border:0;font-weight:800;font-size:16px;cursor:pointer}
    .primary{background:linear-gradient(180deg,var(--primary),var(--primary2));color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-size:14px;display:none;white-space:pre-line}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .mini{font-size:12px;color:var(--muted);margin-top:6px}
    .preview{margin-top:10px;display:none;gap:10px;align-items:center}
    .preview img{width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}
    @media(max-width:720px){.row,.row3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fleurarose Admin Booking</h1>
      <p class="sub" id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</p>

      <div class="row">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
          <input id="customer_name" />
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
          <input id="line_name" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
          <input id="event_date" type="date" />
        </div>
        <div>
          <label>‡πÄ‡∏ß‡∏•‡∏≤ (‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á) *</label>
          <select id="event_time">
            <option value="10:00-14:00">10:00‚Äì14:00</option>
            <option value="18:00-22:00">18:00‚Äì22:00</option>
          </select>
          <div class="mini">Calendar ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Set up (‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡∏µ‡πà‡∏ä‡∏°.)</label>
          <input id="setup_hours" type="number" min="0" step="0.5" value="2" />
        </div>
        <div>
          <label>Package *</label>
          <select id="package_type">
            <option value="PhotoBooth">PhotoBooth</option>
            <option value="Automate">Automate</option>
            <option value="Tel ‡∏ü‡πâ‡∏≤">Tel ‡∏ü‡πâ‡∏≤</option>
            <option value="Tel ‡πÑ‡∏°‡πâ">Tel ‡πÑ‡∏°‡πâ</option>
          </select>
        </div>
        <div>
          <label>Size *</label>
          <select id="size">
            <option value="2x6">2x6</option>
            <option value="4x6">4x6</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
          <input id="location" />
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô/‡∏ä‡∏±‡πâ‡∏ô</label>
          <input id="room_floor" />
        </div>
      </div>

      <label>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
      <input id="contact" />

      <div class="row">
        <div>
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) *</label>
          <input id="price" type="number" min="0" step="1" />
        </div>
        <div>
          <label>‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
          <input id="deposit_amount" type="number" min="0" step="1" value="2000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡πÇ‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="deposit_date" type="date" />
        </div>
        <div>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
          <select id="deposit_status">
            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏≠‡∏ô">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏≠‡∏ô</option>
            <option value="‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
        </div>
      </div>

      <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚â§ 800KB</label>
      <input id="slip_file" type="file" accept="image/*" />
      <div class="preview" id="preview">
        <img id="previewImg" alt="preview"/>
        <div class="mini" id="fileInfo">-</div>
      </div>

      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="notes"></textarea>

      <button class="btn primary" id="btnSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar</button>
      <button class="btn ghost" id="btnAdmin">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏õ‡∏¥‡∏î OA)</button>

      <div class="msg ok" id="msgOk"></div>
      <div class="msg err" id="msgErr"></div>
    </div>
  </div>

  <!-- ‚úÖ hidden iframe + form = ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î CORS/‡πÑ‡∏°‡πà Load failed -->
  <iframe name="hidden_iframe" style="display:none"></iframe>
  <form id="postForm" method="POST" target="hidden_iframe" style="display:none">
    <input type="hidden" name="payload" id="payloadField" />
  </form>

<script>
  const LIFF_ID = "2008882886-ubJheqfN";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvdPqVL7NPkrj3rI9Xv_ocaYfmXqcjWhOHYh3XI7cSuF4-6PXaGcntVK8yt6iml0W/exec";
  const OA_BASIC_ID = "@262clszf";

  const $ = (id)=>document.getElementById(id);
  const okBox = $("msgOk");
  const errBox = $("msgErr");
  function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
  function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
  function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; }

  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function genBookingId(){
    const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let s="FR-";
    for(let i=0;i<8;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  async function readFileAsBase64(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{
        const dataUrl=String(r.result||"");
        const i=dataUrl.indexOf("base64,");
        resolve(i>=0?dataUrl.slice(i+7):"");
      };
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  async function init(){
    $("event_date").value = $("event_date").value || todayISO();
    try{
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const p = await liff.getProfile();
      $("hello").textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ (${p.displayName || "LINE"})`;
    }catch(e){
      $("hello").textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE LIFF ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î";
    }
  }

  $("slip_file").addEventListener("change", ()=>{
    clearMsg();
    const f = $("slip_file").files && $("slip_file").files[0];
    if (!f){ $("preview").style.display="none"; return; }
    $("preview").style.display="flex";
    $("fileInfo").textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
    $("previewImg").src = URL.createObjectURL(f);
    if (f.size > 800*1024) showErr("‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏Å‡∏¥‡∏ô 800KB ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á");
  });

  $("btnAdmin").addEventListener("click", ()=>{
    clearMsg();
    const url = "https://line.me/R/ti/p/" + OA_BASIC_ID;
    try{
      if (window.liff && liff.isInClient()) liff.openWindow({ url, external:true });
      else window.open(url, "_blank");
      showOk("‡πÄ‡∏õ‡∏¥‡∏î OA ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
    }catch(e){
      window.open(url, "_blank");
      showOk("‡πÄ‡∏õ‡∏¥‡∏î OA ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
    }
  });

  function validate(){
    const req = [
      ["customer_name","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"],
      ["line_name","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"],
      ["event_date","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"],
      ["location","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"],
      ["contact","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô/‡πÄ‡∏ö‡∏≠‡∏£‡πå"],
      ["price","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤"],
    ];
    for (const [id,msg] of req){
      if (!$(id).value || !$(id).value.trim()) return msg;
    }
    if (Number($("price").value) <= 0) return "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0";
    return "";
  }

  $("btnSubmit").addEventListener("click", async ()=>{
    clearMsg();
    const v = validate();
    if (v){ showErr(v); return; }

    const btn = $("btnSubmit");
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶";

    const bookingId = genBookingId();

    let slip = null;
    const f = $("slip_file").files && $("slip_file").files[0];
    if (f){
      if (f.size > 1200*1024){
        showErr("‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1.2MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
        btn.disabled = false;
        btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar";
        return;
      }
      const b64 = await readFileAsBase64(f);
      slip = { name:f.name, type:f.type, data:b64 };
    }

    const payloadObj = {
      booking_id: bookingId,
      customer_name: $("customer_name").value.trim(),
      line_name: $("line_name").value.trim(),
      event_date: $("event_date").value.trim(),
      event_time: $("event_time").value.trim(),
      setup_hours: Number($("setup_hours").value || 2),
      location: $("location").value.trim(),
      room_floor: $("room_floor").value.trim(),
      contact: $("contact").value.trim(),
      package_type: $("package_type").value,
      size: $("size").value,
      price: Number($("price").value),
      deposit_amount: Number($("deposit_amount").value || 2000),
      deposit_date: $("deposit_date").value.trim(),
      deposit_status: $("deposit_status").value,
      notes: $("notes").value.trim(),
      slip: slip
    };

    // ‚úÖ ‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ FORM POST (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ fetch) = ‡πÑ‡∏°‡πà Load failed
    const form = $("postForm");
    form.action = GAS_URL; // /exec
    $("payloadField").value = JSON.stringify(payloadObj);

    // trick: doPost ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô e.postData.contents -> ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏¢‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô raw JSON ‡∏ú‡πà‡∏≤‡∏ô "payload" ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞ POST ‡πÄ‡∏õ‡πá‡∏ô "text/plain" ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô form
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ: ‡∏¢‡∏¥‡∏á JSON raw ‡∏î‡πâ‡∏ß‡∏¢ form ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -> ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ Code.gs ‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö payload field ‡πÅ‡∏•‡πâ‡∏ß parse

    // üëâ ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö x-www-form-urlencoded ‡πÅ‡∏•‡πâ‡∏ß Code.gs ‡∏à‡∏∞ parse ‡∏à‡∏≤‡∏Å postData.contents ‡πÄ‡∏õ‡πá‡∏ô 'payload=...'
    form.submit();

    showOk(`‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ\nBooking ID: ${bookingId}\n‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô Sheet ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà`);
    btn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";
  });

  init();
</script>
</body>
</html>
