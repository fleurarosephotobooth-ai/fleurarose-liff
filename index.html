<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleurarose Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:#f6f7fb}
    .wrap{max-width:720px;margin:16px auto;padding:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:18px}
    h1{margin:0 0 4px;font-size:24px}
    .sub{margin:0 0 14px;color:#6b7280;font-size:13px}
    label{display:block;margin-top:12px;color:#6b7280;font-size:13px}
    input,select,textarea{width:100%;box-sizing:border-box;margin-top:6px;padding:12px;border:1px solid #e5e7eb;border-radius:14px;font-size:15px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:16px;border:0;font-weight:800;font-size:16px;cursor:pointer}
    .primary{background:#111827;color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .hint{margin-top:10px;font-size:12px;color:#6b7280;line-height:1.4}
    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-size:14px;display:none;white-space:pre-line}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    @media(max-width:640px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fleurarose Booking</h1>
      <p class="sub" id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LINE‚Ä¶</p>

      <div class="row">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input id="customer_name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
        </div>
        <div>
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
          <input id="phone" placeholder="0xx-xxx-xxxx" inputmode="tel" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="event_date" type="date" />
        </div>
        <div>
          <label>‡∏£‡∏≠‡∏ö</label>
          <select id="time_slot">
            <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ 10:00‚Äì14:00</option>
            <option value="PM">‡πÄ‡∏¢‡πá‡∏ô 18:00‚Äì22:00</option>
          </select>
        </div>
      </div>

      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
      <select id="job_type">
        <option>Photobooth</option>
        <option>Automate</option>
        <option>Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 1</option>
        <option>Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 2</option>
        <option>Telephone booth ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</option>
      </select>

      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
      <input id="location" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° / ‡∏ö‡πâ‡∏≤‡∏ô / ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå" />

      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="notes" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>

      <button class="btn primary" id="btnSubmit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á</button>
      <button class="btn ghost" id="btnAdmin">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>

      <div class="msg ok" id="msgOk"></div>
      <div class="msg err" id="msgErr"></div>

      <div class="hint">
        * ‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br/>
        ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô ‡∏Å‡∏î ‚Äú‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù
      </div>
    </div>
  </div>

<script>
const LIFF_ID = "2008882886-ubJheqfN";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvdPqVL7NPkrj3rI9Xv_ocaYfmXqcjWhOHYh3XI7cSuF4-6PXaGcntVK8yt6iml0W/exec";
const OA_BASIC_ID = "@262clszf";

let profile = { userId:"", displayName:"" };

const $ = (id)=>document.getElementById(id);
const okBox = $("msgOk");
const errBox = $("msgErr");
function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; }

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function makeBookingId(){
  return "FR-" + Math.random().toString(16).slice(2,10).toUpperCase();
}

async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    profile = await liff.getProfile();
    $("hello").textContent = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + (profile.displayName || "");
    if (!$("customer_name").value) $("customer_name").value = profile.displayName || "";
    if (!$("event_date").value) $("event_date").value = todayISO();
  }catch(e){
    $("hello").textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô";
    if (!$("event_date").value) $("event_date").value = todayISO();
  }
}

function validate(){
  if (!profile.userId) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE (LIFF) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô";
  if (!$("customer_name").value.trim()) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
  if (!$("phone").value.trim()) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£";
  if (!$("event_date").value.trim()) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
  return "";
}

// JSONP helper (no CORS)
function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error("JSONP timeout"));
    }, 12000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cb];
      s.remove();
    }

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    s.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP load error"));
    };
    document.body.appendChild(s);
  });
}

$("btnAdmin").addEventListener("click", async ()=>{
  clearMsg();
  try{
    if (window.liff && liff.isInClient()) {
      await liff.sendMessages([{ type:"text", text:"‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" }]);
      showOk("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
    } else {
      window.open("https://line.me/R/ti/p/" + OA_BASIC_ID, "_blank");
      showOk("‡πÄ‡∏õ‡∏¥‡∏î OA ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    }
  }catch(err){
    showErr("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
  }
});

$("btnSubmit").addEventListener("click", async ()=>{
  clearMsg();
  const v = validate();
  if (v) { showErr(v); return; }

  const btn = $("btnSubmit");
  btn.disabled = true;
  btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‚Ä¶";

  const booking_id = makeBookingId();

  // ‡∏™‡πà‡∏á key ‡πÅ‡∏ö‡∏ö snake_case ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á Code.gs ‡∏ä‡∏±‡∏ß‡∏£‡πå
  const payload = {
    booking_id,
    line_user_id: profile.userId,
    line_display_name: profile.displayName,
    customer_name: $("customer_name").value.trim(),
    phone: $("phone").value.trim(),
    event_date: $("event_date").value.trim(),
    time_slot: $("time_slot").value,
    job_type: $("job_type").value,
    location: $("location").value.trim(),
    notes: $("notes").value.trim()
  };

  try{
    // 1) ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Beacon (‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
    const blob = new Blob([JSON.stringify(payload)], { type: "text/plain;charset=utf-8" });
    const sent = navigator.sendBeacon(GAS_URL, blob);

    if (!sent) {
      // fallback
      await fetch(GAS_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });
    }

    // 2) verify ‡∏î‡πâ‡∏ß‡∏¢ JSONP ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Sheet ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏° (‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î CORS)
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Ä¶";
    const checkUrl = GAS_URL + "?action=check&booking_id=" + encodeURIComponent(booking_id);
    const result = await jsonp(checkUrl);

    if (result && result.ok) {
      showOk(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ\nBooking ID: ${booking_id}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${result.status || "Pending"}\n‡∏ó‡∏µ‡∏°: ${result.team || "-"}`);
      btn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";
    } else {
      showErr(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\nBooking ID: ${booking_id}\n(‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ Deploy /exec + Anyone)`);
      btn.disabled = false;
      btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";
    }

  }catch(err){
    showErr("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
    btn.disabled = false;
    btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";
  }
});

init();
</script>
</body>
</html>
