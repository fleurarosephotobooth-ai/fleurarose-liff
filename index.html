<script>
const LIFF_ID = "2008882886-ubJheqfN";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvdPqVL7NPkrj3rI9Xv_ocaYfmXqcjWhOHYh3XI7cSuF4-6PXaGcntVK8yt6iml0W/exec";
const OA_BASIC_ID = "@262clszf";

let profile = { userId:"", displayName:"" };

const $ = (id)=>document.getElementById(id);
const okBox = $("msgOk");
const errBox = $("msgErr");
function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; }

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    profile = await liff.getProfile();
    $("hello").textContent = "สวัสดี " + (profile.displayName || "");
    if (!$("customer_name").value) $("customer_name").value = profile.displayName || "";
    if (!$("event_date").value) $("event_date").value = todayISO();

  }catch(e){
    $("hello").textContent = "เปิดใน LINE เพื่อจองได้สะดวกขึ้น";
    if (!$("event_date").value) $("event_date").value = todayISO();
  }
}

function validate(){
  if (!profile.userId) return "กรุณาเปิดผ่าน LINE (LIFF) เพื่อยืนยันตัวตน";
  if (!$("customer_name").value.trim()) return "กรุณากรอกชื่อ";
  if (!$("phone").value.trim()) return "กรุณากรอกเบอร์โทร";
  if (!$("event_date").value.trim()) return "กรุณาเลือกวันที่";
  return "";
}

$("btnAdmin").addEventListener("click", async ()=>{
  clearMsg();
  try{
    if (window.liff && liff.isInClient()) {
      await liff.sendMessages([{ type:"text", text:"ติดต่อแอดมิน" }]);
      showOk("ส่งข้อความถึงแอดมินแล้ว ✅");
    } else {
      window.open("https://line.me/R/ti/p/" + OA_BASIC_ID, "_blank");
      showOk("เปิด OA แล้ว ✅ พิมพ์ “ติดต่อแอดมิน” ได้เลย");
    }
  }catch(err){
    showErr("ติดต่อแอดมินไม่สำเร็จ: " + err);
  }
});

$("btnSubmit").addEventListener("click", async ()=>{
  clearMsg();
  const v = validate();
  if (v) { showErr(v); return; }

  const btn = $("btnSubmit");
  btn.disabled = true;
  btn.textContent = "กำลังส่งคำขอจอง…";

  // ✅ ชื่อ key ให้ตรงกับ Code.gs
  const payload = {
    booking_id: "FR-" + Math.random().toString(16).slice(2,10).toUpperCase(),
    line_user_id: profile.userId,
    line_display_name: profile.displayName,

    customer_name: $("customer_name").value.trim(),
    phone: $("phone").value.trim(),
    event_date: $("event_date").value.trim(), // YYYY-MM-DD
    time_slot: $("time_slot").value,         // AM/PM
    job_type: $("job_type").value,

    location: $("location").value.trim(),
    notes: $("notes").value.trim()
  };

  try{
    // ⭐ no-cors กัน LIFF ค้าง/Failed to fetch จาก CORS
    await fetch(GAS_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(payload)
    });

    // no-cors จะอ่าน response ไม่ได้ → ให้ถือว่าส่งสำเร็จและไปเช็คในชีต
    showOk(`ส่งคำขอจองเรียบร้อย ✅\nBooking ID: ${payload.booking_id}\n(เช็คสถานะได้ใน Google Sheet)`);
    btn.textContent = "ส่งแล้ว ✅";

  }catch(err){
    showErr("ส่งไม่สำเร็จ: " + (err.message || err));
    btn.disabled = false;
    btn.textContent = "ส่งคำขอจอง";
  }
});

init();
</script>
