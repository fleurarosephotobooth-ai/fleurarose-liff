<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleurarose Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --primary:#0b1220; --primary2:#111827;
      --okbg:#ecfdf5; --ok:#065f46; --okbd:#a7f3d0;
      --erbg:#fef2f2; --er:#991b1b; --erbd:#fecaca;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:18px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .badge{font-size:12px;color:#0ea5e9;background:#e0f2fe;border:1px solid #bae6fd;padding:6px 10px;border-radius:999px}
    .sub{margin:8px 0 14px;color:var(--muted);font-size:13px;line-height:1.5}
    label{display:block;margin-top:12px;color:var(--muted);font-size:13px}
    input,select,textarea{
      width:100%;margin-top:6px;padding:12px 12px;border:1px solid var(--line);
      border-radius:16px;font-size:15px;background:#fff;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.25)}
    textarea{min-height:92px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{
      width:100%;margin-top:14px;padding:14px 14px;border-radius:18px;border:0;
      font-weight:800;font-size:16px;cursor:pointer;transition:.15s transform, .15s opacity;
    }
    .btn:active{transform:scale(.99)}
    .primary{background:linear-gradient(180deg,var(--primary2),var(--primary));color:#fff}
    .ghost{background:#eef2ff;color:#111827;border:1px solid #e0e7ff}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}
    .msg{
      margin-top:12px;padding:11px 12px;border-radius:16px;font-size:14px;display:none;white-space:pre-line
    }
    .ok{background:var(--okbg);color:var(--ok);border:1px solid var(--okbd)}
    .err{background:var(--erbg);color:var(--er);border:1px solid var(--erbd)}
    .mini{font-size:12px;color:var(--muted);margin-top:8px}
    .req{color:#ef4444;font-weight:700}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1>Fleurarose Booking</h1>
        <div class="badge" id="envBadge">LIFF</div>
      </div>

      <p class="sub" id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LINE‚Ä¶</p>

      <div class="grid">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="req">*</span></label>
          <input id="customer_name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" autocomplete="name" />
        </div>
        <div>
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ <span class="req">*</span></label>
          <input id="phone" placeholder="0xx-xxx-xxxx" inputmode="tel" autocomplete="tel" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="req">*</span></label>
          <input id="event_date" type="date" />
        </div>
        <div>
          <label>‡∏£‡∏≠‡∏ö <span class="req">*</span></label>
          <select id="time_slot">
            <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ 10:00‚Äì14:00</option>
            <option value="PM">‡πÄ‡∏¢‡πá‡∏ô 18:00‚Äì22:00</option>
          </select>
        </div>
      </div>

      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô <span class="req">*</span></label>
      <select id="job_type">
        <option value="Photobooth">Photobooth</option>
        <option value="Automate">Automate</option>
        <option value="Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 1">Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 1</option>
        <option value="Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 2">Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 2</option>
        <option value="Telephone booth ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•">Telephone booth ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</option>
      </select>

      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
      <input id="location" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° / ‡∏ö‡πâ‡∏≤‡∏ô / ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå" />

      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="notes" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>

      <button class="btn primary" id="btnSubmit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á</button>
      <button class="btn ghost" id="btnAdmin">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>

      <div class="msg ok" id="msgOk"></div>
      <div class="msg err" id="msgErr"></div>
      <div class="mini" id="miniInfo"></div>

      <div class="hint">
        * ‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br/>
        ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô ‡∏Å‡∏î ‚Äúüí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù
      </div>
    </div>
  </div>

<script>
/** ‚úÖ ‡πÅ‡∏Å‡πâ 2 ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏¥‡∏ß */
const LIFF_ID = "2008882886-ubJheqfN";
const GAS_URL  = "https://script.google.com/macros/s/AKfycbxWvdPqVL7NPkrj3rI9Xv_ocaYfmXqcjWhOHYh3XI7cSuF4-6PXaGcntVK8yt6iml0W/exec";

/** OA Basic ID ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏¥‡∏ß */
const OA_BASIC_ID = "@262clszf";

let profile = { userId:"", displayName:"" };

const $ = (id)=>document.getElementById(id);
const okBox = $("msgOk");
const errBox = $("msgErr");
const mini = $("miniInfo");

function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; okBox.textContent=""; errBox.textContent=""; }
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function validate(){
  const name = $("customer_name").value.trim();
  const phone = $("phone").value.trim();
  const date = $("event_date").value.trim();
  const slot = $("time_slot").value;
  const jt = $("job_type").value;

  if (!name) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•";
  if (!phone) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£";
  if (!date) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
  if (!slot) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö";
  if (!jt) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô";
  return "";
}

/**
 * ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÅ‡∏ö‡∏ö ‚Äú‡∏õ‡∏•‡∏≠‡∏î preflight‚Äù:
 * - ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô text/plain + JSON string
 * - server (GAS) parse ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å postData.contents
 */
async function postBooking(payload){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), 20000);

  try{
    const res = await fetch(GAS_URL, {
      method: "POST",
      // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: text/plain ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ preflight/CORS ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏™‡∏ö‡∏ô iOS/LIFF
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
      signal: controller.signal,
    });

    // ‡∏ö‡∏≤‡∏á‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ‚Üí ‡πÄ‡∏£‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch { data = { ok:false, raw:text }; }

    return { httpOk: res.ok, data, raw:text };
  } finally {
    clearTimeout(timer);
  }
}

/** ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÄ‡∏õ‡∏¥‡∏î OA ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á scope) */
function openAdminChat(){
  const text = encodeURIComponent("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
  const url = `https://line.me/R/oaMessage/${OA_BASIC_ID}/?${text}`;
  if (window.liff && liff.isInClient && liff.isInClient()){
    liff.openWindow({ url, external: true });
  } else {
    window.open(url, "_blank");
  }
}

$("btnAdmin").addEventListener("click", ()=>{
  clearMsg();
  openAdminChat();
  showOk("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
});

/** Init LIFF */
async function init(){
  $("event_date").value = todayISO();

  try{
    await liff.init({ liffId: LIFF_ID });

    const inClient = liff.isInClient();
    $("envBadge").textContent = inClient ? "LIFF (in LINE)" : "LIFF (external)";
    mini.textContent = inClient ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£";

    if (!liff.isLoggedIn()){
      liff.login();
      return;
    }

    profile = await liff.getProfile();
    $("hello").textContent = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + (profile.displayName || "");
    if (!$("customer_name").value) $("customer_name").value = profile.displayName || "";

  }catch(e){
    $("envBadge").textContent = "Web";
    $("hello").textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô";
    mini.textContent = "‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡πá‡∏ö: ‡∏¢‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE";
  }
}

$("btnSubmit").addEventListener("click", async ()=>{
  clearMsg();

  const v = validate();
  if (v) { showErr(v); return; }

  const btn = $("btnSubmit");
  btn.disabled = true;
  btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‚Ä¶";

  const payload = {
    lineUserId: profile.userId || "",
    displayName: profile.displayName || "",
    customerName: $("customer_name").value.trim(),
    phone: $("phone").value.trim(),
    eventDate: $("event_date").value.trim(),   // yyyy-mm-dd
    timeSlot: $("time_slot").value,            // AM/PM
    jobType: $("job_type").value,
    location: $("location").value.trim(),
    notes: $("notes").value.trim(),
    client: {
      ua: navigator.userAgent,
      ts: new Date().toISOString()
    }
  };

  try{
    const { httpOk, data, raw } = await postBooking(payload);

    // ‚úÖ ‡πÄ‡∏Ñ‡∏™‡∏õ‡∏Å‡∏ï‡∏¥ (GAS ‡∏Ñ‡∏∑‡∏ô JSON)
    if (httpOk && data && data.ok){
      const bid = data.booking_id || "-";
      const team = data.team_assigned ? `\n‡∏ó‡∏µ‡∏°: ${data.team_assigned}` : "";
      showOk(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ\nBooking ID: ${bid}${team}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${data.status || "Pending"}`);
      btn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";
      return;
    }

    // ‚ö†Ô∏è ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á iOS/LIFF ‡∏≠‡πà‡∏≤‡∏ô response ‡πÅ‡∏•‡πâ‡∏ß parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ù‡∏±‡πà‡∏á GAS ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ä‡∏µ‡∏ï‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    // ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï/‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    const maybeBid = (raw || "").match(/FR-[A-Z0-9]{6,}/)?.[0] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    showErr(
      `‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö\n` +
      `Booking ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ): ${maybeBid}\n` +
      `‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏≠ 5‚Äì10 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Google Sheet ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î ‚Äúüí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù`
    );
    btn.disabled = false;
    btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";

  }catch(err){
    const msg = String(err?.name) === "AbortError"
      ? "Timeout 20s ‚Äî ‡πÄ‡∏ä‡πá‡∏Ñ Deploy ‡πÄ‡∏õ‡πá‡∏ô /exec ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Anyone"
      : (err?.message || String(err));

    showErr("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + msg);
    btn.disabled = false;
    btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";
  }
});

init();
</script>
</body>
</html>
