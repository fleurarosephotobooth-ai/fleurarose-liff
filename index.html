<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleurarose Admin Booking Form</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --line:#e5e7eb; --muted:#6b7280; --text:#111827;
      --primary:#111827; --soft:#eef2ff; --okbg:#ecfdf5; --ok:#065f46; --errbg:#fef2f2; --err:#991b1b;
      --radius:18px;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:860px;margin:18px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 25px rgba(0,0,0,.06);padding:18px}
    h1{margin:0 0 4px;font-size:24px}
    .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.4}
    label{display:block;margin-top:12px;color:var(--muted);font-size:13px}
    input,select,textarea{width:100%;box-sizing:border-box;margin-top:6px;padding:12px;border:1px solid var(--line);border-radius:14px;font-size:15px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:16px;border:0;font-weight:800;font-size:16px;cursor:pointer}
    .primary{background:var(--primary);color:#fff}
    .ghost{background:var(--soft);color:var(--text)}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}
    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-size:14px;display:none;white-space:pre-line}
    .ok{background:var(--okbg);color:var(--ok);border:1px solid #a7f3d0}
    .err{background:var(--errbg);color:var(--err);border:1px solid #fecaca}
    .preview{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .thumb{width:74px;height:74px;border-radius:14px;border:1px solid var(--line);object-fit:cover;background:#fff}
    .pill{font-size:12px;color:var(--muted);background:#f3f4f6;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    @media(max-width:720px){.row,.row3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fleurarose Booking (Admin Form)</h1>
      <p class="sub">
        กรอกฟอร์ม → บันทึกเข้า Google Sheet → สร้าง Calendar อัตโนมัติทันที ✅<br/>
        (ไม่มี LINE userId / ไม่มีการส่งข้อความลูกค้า)
      </p>

      <label>ชื่อลูกค้า *</label>
      <input id="customer_name" placeholder="เช่น คุณเมย์" />

      <div class="row">
        <div>
          <label>ชื่อไลน์ลูกค้า (Line Display Name) *</label>
          <input id="line_name" placeholder="เช่น MOREMEW" />
        </div>
        <div>
          <label>ผู้ประสานงาน/เบอร์ติดต่อ *</label>
          <input id="contact" placeholder="ชื่อผู้ประสานงาน / 0xx-xxx-xxxx" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>วันที่จัดงาน *</label>
          <input id="event_date" type="date" />
        </div>
        <div>
          <label>เวลา (ช่วงงาน) *</label>
          <input id="event_time" placeholder="เช่น 10:00–14:00" />
        </div>
      </div>

      <label>Set up (ก่อนงาน)</label>
      <select id="setup_hours">
        <option value="2">ก่อนงาน 2 ชม.</option>
        <option value="1">ก่อนงาน 1 ชม.</option>
        <option value="3">ก่อนงาน 3 ชม.</option>
      </select>

      <label>สถานที่ *</label>
      <input id="location" placeholder="ชื่อสถานที่/โรงแรม/บ้าน/อีเวนต์" />

      <div class="row">
        <div>
          <label>ชื่อห้องที่จัดงาน/ชั้น</label>
          <input id="room_floor" placeholder="เช่น Ballroom ชั้น 2" />
        </div>
        <div>
          <label>จองแพคเกจ (size / ราคา) *</label>
          <input id="package" placeholder="เช่น M / 12,900" />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>มัดจำ (บาท)</label>
          <input id="deposit_amount" type="number" value="2000" />
        </div>
        <div>
          <label>โอนมัดจำวันที่</label>
          <input id="deposit_date" type="date" />
        </div>
        <div>
          <label>หมายเหตุ</label>
          <input id="notes" placeholder="ถ้ามี..." />
        </div>
      </div>

      <label>แนบรูปภาพสลิปมัดจำ (ถ้ามี)</label>
      <input id="slip" type="file" accept="image/*" />
      <div class="preview" id="preview" style="display:none">
        <img class="thumb" id="thumb" alt="preview"/>
        <span class="pill" id="fileInfo"></span>
      </div>

      <button class="btn primary" id="btnSubmit">บันทึก + สร้าง Calendar</button>

      <div class="msg ok" id="msgOk"></div>
      <div class="msg err" id="msgErr"></div>

      <div class="hint">
        * ระบบจะสร้างอีเวนต์ “Set up” ล่วงหน้า (ก่อนงานตามชั่วโมงที่เลือก)<br/>
        * ถ้าแนบสลิป ระบบจะอัปโหลดเข้า Google Drive และเก็บลิงก์ไว้ใน Sheet
      </div>
    </div>
  </div>

<script>
  // ✅ เปลี่ยนเป็น URL Web App /exec ของหมิว
  const GAS_URL = "PUT_YOUR_GAS_WEBAPP_EXEC_URL_HERE";

  const $ = (id)=>document.getElementById(id);
  const okBox = $("msgOk"), errBox = $("msgErr");
  function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
  function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
  function clearMsg(){ okBox.style.display="none"; errBox.style.display="none"; }

  function todayISO(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function validate(){
    if (!$("customer_name").value.trim()) return "กรุณากรอกชื่อลูกค้า";
    if (!$("line_name").value.trim()) return "กรุณากรอกชื่อไลน์ลูกค้า";
    if (!$("contact").value.trim()) return "กรุณากรอกผู้ประสานงาน/เบอร์ติดต่อ";
    if (!$("event_date").value.trim()) return "กรุณาเลือกวันที่จัดงาน";
    if (!$("event_time").value.trim()) return "กรุณากรอกเวลา (ช่วงงาน)";
    if (!$("location").value.trim()) return "กรุณากรอกสถานที่";
    if (!$("package").value.trim()) return "กรุณากรอกแพคเกจ (size/ราคา)";
    return "";
  }

  // preview slip
  $("slip").addEventListener("change", ()=>{
    const f = $("slip").files && $("slip").files[0];
    if (!f){ $("preview").style.display="none"; return; }
    $("preview").style.display="flex";
    $("thumb").src = URL.createObjectURL(f);
    $("fileInfo").textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
  });

  // default dates
  $("event_date").value = todayISO();

  $("btnSubmit").addEventListener("click", async ()=>{
    clearMsg();
    const v = validate();
    if (v){ showErr(v); return; }
    if (!GAS_URL || GAS_URL.includes("PUT_YOUR_GAS_WEBAPP_EXEC_URL_HERE")){
      showErr("ยังไม่ได้ใส่ GAS_URL ใน index.html");
      return;
    }

    const btn=$("btnSubmit");
    btn.disabled=true;
    btn.textContent="กำลังบันทึก…";

    // สร้าง payload เป็น base64 ถ้ามีไฟล์
    const file = $("slip").files && $("slip").files[0];
    let slipObj = null;

    if (file){
      const b64 = await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(String(r.result).split(",")[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
      slipObj = { name:file.name, type:file.type, data:b64 };
    }

    const payload = {
      customer_name: $("customer_name").value.trim(),
      line_name: $("line_name").value.trim(),
      contact: $("contact").value.trim(),
      event_date: $("event_date").value.trim(),   // YYYY-MM-DD
      event_time: $("event_time").value.trim(),   // "10:00–14:00"
      setup_hours: Number($("setup_hours").value || 2),
      location: $("location").value.trim(),
      room_floor: $("room_floor").value.trim(),
      package: $("package").value.trim(),
      deposit_amount: Number($("deposit_amount").value || 2000),
      deposit_date: $("deposit_date").value.trim(),
      notes: $("notes").value.trim(),
      slip: slipObj
    };

    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), 25000);

    try{
      // ✅ ใช้ JSONP แบบ GET เพื่อหลบปัญหา fetch/cors บน iOS บางเคส
      const cbName = "cb_" + Math.random().toString(16).slice(2);
      const url = GAS_URL + "?action=create&payload=" + encodeURIComponent(JSON.stringify(payload)) + "&callback=" + cbName;

      const data = await new Promise((resolve, reject)=>{
        window[cbName] = (resp)=>{ resolve(resp); cleanup(); };
        const s=document.createElement("script");
        s.src=url;
        s.onerror=()=>{ reject(new Error("JSONP load error")); cleanup(); };
        document.body.appendChild(s);

        function cleanup(){
          try{ delete window[cbName]; }catch{}
          if (s && s.parentNode) s.parentNode.removeChild(s);
        }
      });

      if (!data || !data.ok) throw new Error((data && data.error) || "บันทึกไม่สำเร็จ");

      showOk(`บันทึกสำเร็จ ✅\nBooking ID: ${data.booking_id}\nCalendar: สร้างแล้ว`);
      btn.textContent="บันทึกแล้ว ✅";

    }catch(err){
      showErr("ส่งไม่สำเร็จ: " + (err.message || err));
      btn.disabled=false;
      btn.textContent="บันทึก + สร้าง Calendar";
    }finally{
      clearTimeout(timer);
    }
  });
</script>
</body>
</html>
