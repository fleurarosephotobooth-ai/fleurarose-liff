<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fleurarose Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--shadow:0 16px 40px rgba(2,6,23,.10);--r:20px}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:780px;margin:18px auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    h1{margin:0;font-size:22px}
    .sub{margin:6px 0 14px;color:var(--muted);font-size:13px;line-height:1.5}
    label{display:block;margin-top:12px;color:var(--muted);font-size:13px}
    input,select,textarea{width:100%;margin-top:6px;padding:12px;border:1px solid var(--line);border-radius:16px;font-size:15px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.25)}
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{width:100%;margin-top:14px;padding:14px;border-radius:18px;border:0;font-weight:800;font-size:16px;cursor:pointer}
    .primary{background:#111827;color:#fff}
    .ghost{background:#eef2ff;color:#111827;border:1px solid #e0e7ff}
    .msg{margin-top:12px;padding:10px 12px;border-radius:16px;font-size:14px;display:none;white-space:pre-line}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Fleurarose Booking</h1>
    <div class="sub" id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LINE‚Ä¶</div>

    <div class="grid">
      <div>
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
        <input id="customerName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <div>
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label>
        <input id="phone" placeholder="0xx-xxx-xxxx" inputmode="tel">
      </div>
    </div>

    <div class="grid">
      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
        <input id="eventDate" type="date">
      </div>
      <div>
        <label>‡∏£‡∏≠‡∏ö *</label>
        <select id="timeSlot">
          <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ 10:00‚Äì14:00</option>
          <option value="PM">‡πÄ‡∏¢‡πá‡∏ô 18:00‚Äì22:00</option>
        </select>
      </div>
    </div>

    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô *</label>
    <select id="jobType">
      <option>Photobooth</option>
      <option>Automate</option>
      <option>Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 1</option>
      <option>Telephone booth ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß 2</option>
      <option>Telephone booth ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</option>
    </select>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
    <input id="location" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° / ‡∏ö‡πâ‡∏≤‡∏ô / ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå">

    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <textarea id="notes" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>

    <button class="btn primary" id="btnSubmit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á</button>
    <button class="btn ghost" id="btnAdmin">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>

    <div class="msg ok" id="ok"></div>
    <div class="msg err" id="err"></div>

    <div class="hint">
      * ‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
      ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô ‡∏Å‡∏î ‚Äúüí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008882886-ubJheqfN";
const GAS_URL = "https://script.google.com/macros/s/AKfycbzrnTE0rFsVUEhCefTItywFcI_hjpLFPV2C6nGFDaEU_CPDxq5XywG6BBRdzwzt3Edk/exec"; // <-- ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏Ç‡∏≠‡∏á Apps Script
const OA_BASIC_ID = "@262clszf";

let profile = { userId:"", displayName:"" };
const $ = (id)=>document.getElementById(id);
const okBox=$("ok"), errBox=$("err");

function showOk(t){ okBox.style.display="block"; errBox.style.display="none"; okBox.textContent=t; }
function showErr(t){ errBox.style.display="block"; okBox.style.display="none"; errBox.textContent=t; }
function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

async function postAPI(body){
  const res = await fetch(GAS_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body),
  });
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch{ data={ok:false,error:txt}; }
  if(!res.ok) throw new Error(`HTTP ${res.status}: ${txt}`);
  return data;
}

async function init(){
  $("eventDate").value = todayISO();
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    profile = await liff.getProfile();
    $("hello").textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName || ""}`;
    if(!$("customerName").value) $("customerName").value = profile.displayName || "";
  }catch(e){
    $("hello").textContent = "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå";
  }
}

function openAdminContact(){
  const text = encodeURIComponent("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
  const url = `https://line.me/R/oaMessage/${OA_BASIC_ID}/?${text}`;
  if(window.liff && liff.isInClient()) liff.openWindow({ url, external:true });
  else window.open(url, "_blank");
}

$("btnAdmin").addEventListener("click", openAdminContact);

$("btnSubmit").addEventListener("click", async ()=>{
  okBox.style.display="none"; errBox.style.display="none";

  const customerName = $("customerName").value.trim();
  const phone = $("phone").value.trim();
  const eventDate = $("eventDate").value.trim();
  if(!customerName) return showErr("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•");
  if(!phone) return showErr("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  if(!eventDate) return showErr("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

  const btn = $("btnSubmit");
  btn.disabled = true;
  btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‚Ä¶";

  try{
    const data = await postAPI({
      action:"submit",
      lineUserId: profile.userId || "",
      displayName: profile.displayName || "",
      customerName,
      phone,
      eventDate,
      timeSlot: $("timeSlot").value,
      jobType: $("jobType").value,
      location: $("location").value.trim(),
      notes: $("notes").value.trim()
    });

    if(!data.ok) throw new Error(data.error || "‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    if(data.status === "Rejected"){
      showErr(`‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚ùå\nBooking ID: ${data.booking_id}`);
      btn.disabled = false; btn.textContent="‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";
      return;
    }

    showOk(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ\nBooking ID: ${data.booking_id}\n‡∏ó‡∏µ‡∏°: ${data.team_assigned || "-"}`);
    btn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";

  }catch(e){
    showErr("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e.message || e));
    btn.disabled = false;
    btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á";
  }
});

init();
</script>
</body>
</html>
